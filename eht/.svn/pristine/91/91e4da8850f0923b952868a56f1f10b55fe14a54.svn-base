<%@page import="com.eht.common.constant.Constants"%>
<%@ page language="java" contentType="text/html; charset=utf-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jstl/fmt_rt"%>
<%@ taglib prefix="xd" uri="http://www.xd-tech.com.cn/" %>
<%
	String path = request.getContextPath();
	String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort() + path;
	String frontPath = basePath + "/webpage/front";
	String cssPath = basePath + "/webpage/front/css";
	String imgPath = basePath + "/webpage/front/images";
%>
<c:set var="webRoot" value="<%=basePath%>" />
<c:set var="frontPath" value="<%=frontPath%>" />
<c:set var="cssPath" value="<%=cssPath%>" />
<c:set var="imgPath" value="<%=imgPath%>" />

<link rel="stylesheet" href="${cssPath}/zTreeStyle/tagTree.css" type="text/css"/>
<script type="text/javascript" src="${frontPath}/js/jquery.sinaEmotion.js"></script>
	<%-- <div class="right_top">
          <div class="Nav" id="nav_div"><a href="${webRoot}/indexController/front/index.dht" onclick="subjectManage()">首页</a></div>
    </div> --%>
   <div class="right_index" id="right_index" style="margin-bottom:1px">
	<!-- Begin notes-->
    <div class="notes" style="width:33%;"> 
      <!-- Begin function-->
      <div id="topFuncDiv" class="function" style="height:70px;width:95%;position:relative">
        <div class="search" style="width:97%;">
          <input type="hidden" name="dirId" id="note_dirId" value="${dirId }"/>
          <table width="100%" border="0" cellspacing="0" cellpadding="0">
            <tr>
              <td class="search_input"><input class="InputTxt1" style="width:85%;line-height:26px;" type="text" name="searchInput" id="searchNoteField" value="${searchInput }"/></td>
              <td class="search_btn"><input class="Button1"  onclick="searchNotes()" type="button" name="note_search" id="note_search" value="搜索" /></td>
            </tr>
          </table>
        </div>
        <div  style="width:93%;"> 
	        <div class="others" style="float:left;margin-top:4px;height:30px;width:70%">
				<input type="hidden" name="tagId" id="note_tagId" value="${tagId }"/>
				<input type="hidden" name="parentTag" id="note_parentTag" value="${parentTag }"/>
				<input type="hidden" name="rootTag" id="note_rootTag" value="${rootTag }"/>
				<input id="tagSelect" style="float:left;height:25px;width:66%" type="text" onclick="showTagTree()" readonly value="" class="InputTxt_tag"/>
				<img alt="" src="${imgPath}/delete.png" style="cursor:pointer;float:left;margin-top:7px;" onclick='$("#tagSelect").val("");$("#note_tagId").val("");searchNotes();' width="20" height="20">
				<!-- <input id="tagQuery_btn" style="float:right;width:98px;" onclick="showTagTree()" class="Button5" type="button" value="标签过滤" name="tagQuery_btn"/> -->
			</div>
	        <div class="others" style="float:right;margin-top:5px;width:30%">
	         <style> 
				.box{border:1px solid 
				#C0C0C0;width:75px;height:23px;clip:rect(0px,181px,18px,0px);overflow:hidden;} 
				.box2{border:1px solid 
				#F4F4F4;width:75px;height:23px;clip:rect(0px,179px,16px,0px);overflow:hidden;} 
				select{position:relative;left:-2px;top:-2px;font-size:12px;width:76px;height:25px;line-height:14px;bo 
				rder:0px;color:#909993;} 
			</style> 
			<div class=box>
				<div class=box2>
			          <select hidefocus name="orderField" id="noteOrderField" onchange="searchNotes()">
			            <option value="createTime" <c:if test="${orderField == 'createTime'}">selected="selected"</c:if>>时间排序 </option>
			            <option value="title" <c:if test="${orderField == 'title'}">selected="selected"</c:if>>标题排序 </option>
			         </select>
		         </div>
		    </div> 
	          <!-- <input class="Button2" style="float:right;" onclick="addNewNote()" type="button" name="note_new" id="note_new" value="+ 新建条目" /> -->
	        </div>
		</div>
        <div class="clear"></div>
      </div>
      <!-- End function--> 
      <!-- Begin notes_list-->
      <div class="notes_list" id="noteListIframe" style="width:93%;padding-left:10px;padding-top:10px;padding-right:5px;height:100%">
		<jsp:include page="./notelist.jsp"></jsp:include>
	  </div>
      <!-- End notes_list--> 
    </div>
    <!-- End notes--> 
    
    <!-- Begin notes_new-->
    <div id="notes_new" class="notes_new" style="width:67%;"> 
      	<jsp:include page="./notecontent.jsp"></jsp:include>
    </div>
    <!-- End notes_new-->
    <div class="clear"></div>
   </div>   
    <div id="tagContent" class="menuContent" style="background:#FFFFFF;font-size:13px;border:1px solid #3C85BA;display:none; position: absolute;z-index:1002">
		<ul id="tagTree" class="tag_tree" style="margin-top:0; width:186px;"></ul>
	</div>
	<div id="divhiden" style="display:none;">
		
	</div>
	<script>
	// 滚动浮动
	var funcDiv_top = $("#topFuncDiv").offset().top;
	var funcDiv_left = $("#topFuncDiv").offset().left;
	var topFuncDivWidth = $("#topFuncDiv").width();
	window.onscroll = function(){
	    var t = document.documentElement.scrollTop || document.body.scrollTop; 
	    var top_div = $("#topFuncDiv");
	    if(t >= funcDiv_top) {
	        top_div.addClass("topDiv");
	        $("#topFuncDiv").width(topFuncDivWidth);
	    } else {
	        top_div.removeClass("topDiv");
	    }
	};
		//显示、隐藏评论
      	function togComment(){
      		$("#comments_list").toggle();
      		var src = $("#comment_img").attr("src");
      		if(src.indexOf("comments1a.png") != -1){
      			$("#comment_img").attr("src", "${imgPath}/comments1b.png");
      		}else{
      			$("#comment_img").attr("src", "${imgPath}/comments1a.png");
      		}
      	}
      
      	
      	function restoreNote(id){
      		if(!id){
      			id = $("#noteForm_id").val();
      		}
      		var url = "${webRoot}/noteController/front/restoreNote.dht?id=" + id;
      		AT.post(url, null, function(data){
          		if(data.dirId!=''){
          			var delnode = zTree_Menu.getNodesByParam("id",data.dirId+"_deleted", null);
              		zTree_Menu.removeNode(delnode[0]);
          			var parentNode = zTree_Menu.getNodeByParam("id", data.subjectId, null);
    				zTree_Menu.reAsyncChildNodes(parentNode, "refresh", true);
              		}
      			
      			searchNotes(1);
      		});
      	}

		//拼接标签位置
		function spellTag(nodeid,tagId){
			var params = {"subjectid":nodeid,"tagId":tagId};  
			var url = "${webRoot}/noteController/front/getTreePath.dht";
			AT.post(url, params, function(data){
				var ht = Array();
				var text = "";
				$.each(data, function(i, objVal) { //遍历对象数组，index是数组的索引号，objVal是遍历的一个对象。  
					ht.unshift(objVal);
	            }); 
				$.each(ht, function(i, node) { //遍历对象数组，index是数组的索引号，objVal是遍历的一个对象。  
					text+="-><span style='border: 2px solid rgb(213, 213, 213);'>"+node.name+"</span>" 
	            }); 
		    	$("#tagSelectNode").html(text);
			}); 
		}

		//获取当前note的附件
		function noteAttachment(attaList){
			$("#currAttachment1").html("");
			var text = "";
			if(attaList){
				$.each(attaList, function(i, attachment) { //遍历对象数组，index是数组的索引号，objVal是遍历的一个对象。
					var attaStr = attachment.fileName!=null&&attachment.fileName.length>8?attachment.fileName.substring(0,7)+'...':attachment.fileName;
					text+=
						'<span style="display: inline-block;margin-right:10px;" title="'+attachment.fileName+'">'+
						'<input type="hidden" value="'+attachment.id+'" name="filename">'+
						"<span onclick='downloadByid(\""+attachment.id+"\")'><a href='javascript:;' style='color: #1F8919;'>"+attaStr+"</a>&nbsp;</span>"+
						'<span onclick="removeCurrAttachment(this)" attaid="'+attachment.id+'">'+
						'<a href="javascript:;" >删除</a>'+
						'</span>'+
				 		'</span>';
		            }); 
			}
	    	$("#currAttachment1").html(text);
		}
      	function addNewNote(){
			$("#restoreNote_btn").hide();
			$("#comments_div").hide();//隐藏评论
  			$("#selectTag").show();//标签控制显示选择功能
      		if($("#note_new").val() != "- 撤消条目"){
      		$('#saveNote_btn').show();
      			// 标题输入框
    			if(typeof($("#noteTitleField").attr("disabled")) != "undefined"){
    				$("#noteTitleField").removeAttr("disabled");
    			}
    			// 内容编辑器
    			noteEditor.setEnabled();
    			
    			// 提交按钮
    			if(typeof($("#saveNote_btn").attr("disabled")) != "undefined"){
    				$("#saveNote_btn").removeAttr("disabled");
    			}
    			$("#edui1_toolbarboxouter").children(".edui-editor-toolbarboxinner").show();
      			
	      		$("#noteTitleField").val("新建条目");
	      		$("#noteForm_id").val("");
	  			$("#noteForm_version").val(1);
	  			$("#noteForm_tagId").val("");
	  			UE.getEditor("note_editor").setContent("");
	  			UE.getEditor("note_editor").sync("noteForm");
	  			//新建条目
	  	    	$('#attachment').hide();
	  	    	$("#currAttachment1").html("");
	  	    	$('#tagSelectNode').html("");
	  	    	$("#note_new").val("- 撤消条目");
	  	    	$("#note_edit").val("编辑条目");
	  	    	$("#note_edit").attr("disabled", "disabled");
      		}else{
      		$('#saveNote_btn').hide();
      			$("#note_new").val("+ 新建条目");
      			$("#noteTitleField").val("");
      			$("#noteForm_tagId").val("");
      			UE.getEditor("note_editor").setContent("");
	  			UE.getEditor("note_editor").sync("noteForm");
	  			disableEditNote();
	  			$("#note_edit").val("编辑条目");
	  			$("#note_edit").attr("disabled", "disabled");
      		}
  	    	
      	}
	</script>
	